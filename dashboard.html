<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Chat Panel (Firebase v8) - Roman Urdu</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f4f6fb;color:#111}
  .wrap{display:flex;height:100vh}
  .left{width:320px;background:#fff;border-right:1px solid #e3e6ea;overflow:auto}
  .left h2{margin:0;padding:14px;background:#5b3db3;color:#fff}
  .user-row{display:flex;gap:10px;align-items:center;padding:12px;border-bottom:1px solid #f1f2f4;cursor:pointer}
  .user-row:hover{background:#fafbff}
  .user-row img{width:48px;height:48px;border-radius:50%;object-fit:cover}
  .user-meta{font-size:14px}
  .status{font-size:12px;color:#666}
  .right{flex:1;display:flex;flex-direction:column}
  .header{padding:12px;background:#5b3db3;color:#fff;display:flex;align-items:center;gap:10px}
  .header img{width:48px;height:48px;border-radius:50%;object-fit:cover}
  .messages{flex:1;padding:16px;overflow:auto;background:#f7f8fb}
  .msg{max-width:70%;padding:10px;border-radius:10px;margin-bottom:10px;word-break:break-word}
  .msg.admin{background:#5b3db3;color:#fff;margin-left:auto}
  .msg.user{background:#eef2ff;color:#111}
  .msg img{max-width:240px;border-radius:8px;display:block;margin-top:8px}
  .controls{padding:10px;border-top:1px solid #e6e9ef;background:#fff;display:flex;gap:8px;align-items:center}
  .controls input[type="text"]{flex:1;padding:10px;border-radius:8px;border:1px solid #d7dbe1}
  .btn{padding:10px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
  .btn.send{background:#28a745;color:#fff}
  .btn.img{background:#ff9800;color:#fff}
  .btn.delete{background:#dc3545;color:#fff}
  .small{font-size:12px;color:#666}
  .action-row{margin-left:auto;display:flex;gap:8px}
  .chat-actions{display:flex;gap:8px}
</style>
</head>
<body>

<div class="wrap">
  <!-- left: chats list -->
  <div class="left" id="chatsList">
    <h2>Chats</h2>
    <!-- chat items injected here -->
  </div>

  <!-- right: chat window -->
  <div class="right">
    <div class="header" id="chatHeader">
      <div style="font-weight:800">Select a chat</div>
      <div class="action-row" style="margin-left:auto">
        <div class="small" id="lastActive">â€”</div>
        <div class="chat-actions" style="margin-left:12px">
          <button class="btn delete" id="deleteMsgBtn" title="Delete selected message" style="display:none">Delete Msg</button>
          <button class="btn delete" id="deleteChatBtn" title="Delete entire chat" style="display:none">Delete Chat</button>
        </div>
      </div>
    </div>

    <div class="messages" id="messages"></div>

    <div class="controls">
      <input type="text" id="adminInput" placeholder="Type message..." />
      <button class="btn img" id="pickImgBtn">ðŸ“·</button>
      <input type="file" id="imgPicker" accept="image/*" style="display:none" />
      <button class="btn send" id="sendBtn">Send</button>
    </div>
  </div>
</div>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
/*
  Admin panel - v8 Firebase
  - Paste as single file
  - Uses DB path: chats/{chatId}/{msgId}
  - Message object assumed: { id, from, sender, userId, userName, avatar, type, partner, text, img, timestamp }
*/

/* ---------- config - use your existing config ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyB0j3fTtE1HYoshQb5FtAJBB5BI9wt3ykg",
  authDomain: "lova-d503f.firebaseapp.com",
  databaseURL: "https://lova-d503f-default-rtdb.firebaseio.com",
  projectId: "lova-d503f",
  storageBucket: "lova-d503f.appspot.com",
  messagingSenderId: "50167847192",
  appId: "1:50167847192:web:648c7a49574e908786266d"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* Admin identity (optional, shown as sender) */
const ADMIN_NAME = "Admin";
const ADMIN_AVATAR = "https://i.pravatar.cc/150?img=12";

/* UI refs */
const chatsList = document.getElementById('chatsList');
const chatHeader = document.getElementById('chatHeader');
const messagesEl = document.getElementById('messages');
const adminInput = document.getElementById('adminInput');
const sendBtn = document.getElementById('sendBtn');
const pickImgBtn = document.getElementById('pickImgBtn');
const imgPicker = document.getElementById('imgPicker');
const deleteMsgBtn = document.getElementById('deleteMsgBtn');
const deleteChatBtn = document.getElementById('deleteChatBtn');
const lastActiveEl = document.getElementById('lastActive');

let currentChat = null;   // chatId string
let currentMsgs = {};     // local snapshot of messages for current chat keyed by msgId
let selectedMsgId = null; // message selected for deletion

/* helper: format time */
function timeAgo(ts){
  if(!ts) return '';
  const diff = Date.now() - Number(ts);
  if(diff < 60000) return 'just now';
  if(diff < 3600000) return Math.floor(diff/60000) + 'm ago';
  if(diff < 86400000) return Math.floor(diff/3600000) + 'h ago';
  return new Date(Number(ts)).toLocaleString();
}

/* load chats list once and on updates */
const chatsRef = db.ref('chats');
let chatsListeners = {}; // to keep child listeners if needed

function refreshChatsList(snapshot){
  const val = snapshot.val() || {};
  chatsList.innerHTML = '<h2>Chats</h2>';
  // build array of {chatId, lastTs, firstMsg, msgsCount}
  const arr = Object.keys(val).map(chatId=>{
    const msgs = val[chatId] || {};
    const list = Object.values(msgs);
    // get last timestamp
    const last = list.reduce((a,b)=> a && a.timestamp && b.timestamp ? (a.timestamp > b.timestamp ? a : b) : (a.timestamp? a: b), list[0] || {});
    const first = list[0] || {};
    return { chatId, lastTs: last ? last.timestamp || 0 : 0, first, count: list.length };
  });
  // sort by lastTs desc (most recent first)
  arr.sort((a,b)=> b.lastTs - a.lastTs);

  arr.forEach(item=>{
    const chatId = item.chatId;
    const name = item.first.userName || chatId;
    const avatar = item.first.avatar || 'https://i.pravatar.cc/80';
    const online = (Date.now() - (item.lastTs||0) < 30000) ? 'online' : 'offline';
    const lastText = item.first.text ? (item.first.text.slice(0,60)) : (item.first.img ? '[image]' : '');
    const el = document.createElement('div');
    el.className = 'user-row';
    el.innerHTML = `
      <img src="${avatar}" />
      <div style="flex:1">
        <div class="user-meta"><strong>${escapeHtml(name)}</strong></div>
        <div class="status">${escapeHtml(lastText)} Â· <span style="color:${online==='online'? '#198754':'#6c757d'}">${online}</span></div>
      </div>
    `;
    el.addEventListener('click', ()=> openChat(chatId));
    chatsList.appendChild(el);
  });

  // if no chats, show message
  if(arr.length === 0){
    const p = document.createElement('div');
    p.style.padding = '12px';
    p.innerHTML = '<div class="small">No chats yet.</div>';
    chatsList.appendChild(p);
  }
}

/* attach listener */
chatsRef.on('value', refreshChatsList);

/* open chat: remove any old listeners and attach new child listeners for messages */
let currentChatListener = null;
function openChat(chatId){
  if(!chatId) return;
  // detach previous
  if(currentChatListener && currentChat){
    db.ref('chats/' + currentChat).off('child_added', currentChatListener);
    db.ref('chats/' + currentChat).off('child_changed', currentChatListener);
    db.ref('chats/' + currentChat).off('child_removed', currentChatListener);
  }
  currentChat = chatId;
  selectedMsgId = null;
  deleteMsgBtn.style.display = 'none';
  deleteChatBtn.style.display = 'inline-block';
  messagesEl.innerHTML = '<div class="small">Loading...</div>';
  chatHeader.innerHTML = '<img src="https://i.pravatar.cc/80" /><div style="font-weight:800">Loading...</div><div class="action-row" style="margin-left:auto"><div class="small" id="lastActive">â€”</div></div>';

  // fetch snapshot once (to compute header info) and then attach realtime child listeners
  db.ref('chats/' + chatId).once('value').then(snap=>{
    const msgs = snap.val() || {};
    const arr = Object.keys(msgs).map(k=> ({ id:k, ...msgs[k] }));
    // sort by timestamp asc
    arr.sort((a,b)=> (Number(a.timestamp||0) - Number(b.timestamp||0)));
    currentMsgs = {}; arr.forEach(m=> currentMsgs[m.id] = m);

    // header: user info from first or last message
    const first = arr[0] || {};
    const displayName = first.userName || chatId;
    const avatar = first.avatar || 'https://i.pravatar.cc/80';
    chatHeader.innerHTML = `<img src="${avatar}" /><div style="font-weight:800">${escapeHtml(displayName)}<div class="small" style="font-weight:normal">${escapeHtml(chatId)}</div></div>
      <div class="action-row" style="margin-left:auto">
        <div class="small" id="lastActive">â€”</div>
        <div class="chat-actions" style="margin-left:12px">
          <button class="btn delete" id="deleteChatBtnInline">Delete Chat</button>
        </div>
      </div>`;

    // wire delete chat inline button
    const delChatBtnInline = document.getElementById('deleteChatBtnInline');
    if(delChatBtnInline){
      delChatBtnInline.onclick = ()=> {
        if(!confirm('Delete entire chat? This will remove messages for both sides.')) return;
        db.ref('chats/' + chatId).remove().then(()=> {
          messagesEl.innerHTML = '<div class="small">Chat deleted.</div>';
          currentChat = null;
          deleteChatBtn.style.display = 'none';
        }).catch(err=> alert('Delete failed: '+ err.message));
      };
    }

    renderMessages(arr);
    updateLastActive(arr);

    // now attach child listeners for live updates (child_added, child_changed, child_removed)
    currentChatListener = function(childSnap){
      const key = childSnap.key;
      const val = childSnap.val();
      if(!val) return;
      // put into currentMsgs then re-render sorted
      currentMsgs[key] = val;
      const arr2 = Object.keys(currentMsgs).map(k=> ({ id:k, ...currentMsgs[k] }));
      arr2.sort((a,b)=> Number(a.timestamp||0) - Number(b.timestamp||0));
      renderMessages(arr2);
      updateLastActive(arr2);
    };
    // child_added
    db.ref('chats/' + chatId).on('child_added', currentChatListener);
    db.ref('chats/' + chatId).on('child_changed', (snap)=> {
      const key = snap.key; const v = snap.val();
      if(v === null){ // removed -> handle in removed listener
        delete currentMsgs[key];
      } else {
        currentMsgs[key] = v;
      }
      const arr2 = Object.keys(currentMsgs).map(k=> ({ id:k, ...currentMsgs[k] }));
      arr2.sort((a,b)=> Number(a.timestamp||0) - Number(b.timestamp||0));
      renderMessages(arr2);
      updateLastActive(arr2);
    });
    db.ref('chats/' + chatId).on('child_removed', (snap)=> {
      const key = snap.key;
      delete currentMsgs[key];
      const arr2 = Object.keys(currentMsgs).map(k=> ({ id:k, ...currentMsgs[k] }));
      arr2.sort((a,b)=> Number(a.timestamp||0) - Number(b.timestamp||0));
      renderMessages(arr2);
      updateLastActive(arr2);
    });

  }).catch(err=>{
    messagesEl.innerHTML = '<div class="small">Error loading chat: '+ err.message +'</div>';
  });
}

/* render messages array (sorted asc) */
function renderMessages(arr){
  messagesEl.innerHTML = '';
  arr.forEach(m=>{
    const div = document.createElement('div');
    const className = (m.from === 'admin' || m.sender === 'admin') ? 'msg admin' : 'msg user';
    div.className = 'msg ' + ((className.indexOf('admin')>-1)?'admin':'user');
    div.dataset.msgId = m.id || '';
    // message header small (timestamp + delete icon)
    const meta = document.createElement('div');
    meta.style.fontSize = '12px';
    meta.style.color = '#666';
    meta.style.marginBottom = '6px';
    meta.innerText = timeAgo(m.timestamp) + (m.userName ? ' Â· ' + m.userName : '');
    div.appendChild(meta);

    if(m.text){
      const t = document.createElement('div');
      t.innerText = m.text;
      div.appendChild(t);
    }
    if(m.img){
      const im = document.createElement('img');
      im.src = m.img;
      im.style.maxWidth = '320px';
      div.appendChild(im);
    }

    // attach click to select for deletion (toggles)
    div.addEventListener('click', ()=>{
      // highlight selection
      const prev = messagesEl.querySelector('.msg.selected');
      if(prev) prev.classList.remove('selected');
      div.classList.add('selected');
      selectedMsgId = div.dataset.msgId;
      deleteMsgBtn.style.display = 'inline-block';
    });

    messagesEl.appendChild(div);
  });
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

/* update last active UI */
function updateLastActive(arr){
  if(!arr || arr.length === 0){
    lastActiveEl.innerText = 'â€”';
    return;
  }
  const last = arr[arr.length-1];
  const ago = timeAgo(last.timestamp);
  const online = (Date.now() - Number(last.timestamp||0) < 30000) ? 'online' : 'offline';
  lastActiveEl.innerText = `${ago} Â· ${online}`;
}

/* send text message (admin) */
sendBtn.addEventListener('click', sendAdminText);
adminInput.addEventListener('keypress', (e)=> { if(e.key === 'Enter') sendAdminText(); });

function sendAdminText(){
  if(!currentChat) return alert('Koi chat select karo.');
  const txt = adminInput.value.trim();
  if(!txt) return;
  const msgId = Date.now().toString() + '_' + Math.floor(Math.random()*9999);
  const payload = {
    id: msgId,
    from: 'admin',
    sender: 'admin',
    text: txt,
    img: '',
    avatar: ADMIN_AVATAR,
    timestamp: Date.now()
  };
  db.ref('chats/' + currentChat + '/' + msgId).set(payload).then(()=>{
    adminInput.value = '';
    // UI will update via listener
  }).catch(err=> alert('Send failed: ' + err.message));
}

/* pick image */
pickImgBtn.addEventListener('click', ()=> {
  if(!currentChat) return alert('Koi chat select karo.');
  imgPicker.click();
});
imgPicker.addEventListener('change', function(){
  const file = this.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e){
    const base64 = e.target.result;
    const msgId = Date.now().toString() + '_' + Math.floor(Math.random()*9999);
    const payload = {
      id: msgId,
      from: 'admin',
      sender: 'admin',
      text: '',
      img: base64,
      avatar: ADMIN_AVATAR,
      timestamp: Date.now()
    };
    db.ref('chats/' + currentChat + '/' + msgId).set(payload).then(()=> {
      // done
    }).catch(err=> alert('Send image failed: '+ err.message));
  };
  reader.readAsDataURL(file);
  this.value = '';
});

/* delete selected message */
deleteMsgBtn.addEventListener('click', ()=>{
  if(!currentChat || !selectedMsgId) return;
  if(!confirm('Delete this message for both sides?')) return;
  db.ref('chats/' + currentChat + '/' + selectedMsgId).remove().then(()=>{
    selectedMsgId = null;
    deleteMsgBtn.style.display = 'none';
    // UI update via listener
  }).catch(err=> alert('Delete failed: '+ err.message));
});

/* delete entire chat (button) */
deleteChatBtn.addEventListener('click', ()=>{
  if(!currentChat) return;
  if(!confirm('Delete ENTIRE chat for both sides?')) return;
  db.ref('chats/' + currentChat).remove().then(()=> {
    currentChat = null;
    messagesEl.innerHTML = '<div class="small">Chat deleted.</div>';
    deleteChatBtn.style.display = 'none';
  }).catch(err=> alert('Delete chat failed: '+ err.message));
});

/* util: escape html */
function escapeHtml(s){
  if(!s) return '';
  return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);});
}

/* Clean up: ensure window unload removes listeners */
window.addEventListener('beforeunload', ()=> {
  try { db.ref('chats').off(); if(currentChat) db.ref('chats/' + currentChat).off(); } catch(e){}
});
</script>
</body>
</html>
